<!DOCTYPE html>    
<html>    
<head>    
  <title>Indian Whatsapp</title>    
  <meta name="viewport" content="width=device-width, initial-scale=1">    
  <style>    
    body { font-family: sans-serif; margin: 0; background: #fff; }    
    
    .topbar {    
      background: #fff;     
      padding: 10px 15px;    
      display: flex;    
      justify-content: space-between;    
      align-items: center;    
    }    
    .topbar span {    
      font-size: 25px;    
      font-weight:bold;    
      color: blueviolet;    
          
    }    
    .icons { display: flex; align-items: center; gap: 15px; }    
    .icons i { font-size: 20px; cursor: pointer; color: black; }    
    .dropdown { position: relative; }    
    .dropdown-menu {    
      position: absolute; top: 30px; right: 0; background: white;    
      border-radius: 6px; overflow: hidden; display: none;    
      flex-direction: column; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 10;    
    }    
    .dropdown-menu.show { display: flex; }    
    .dropdown-menu button {    
      padding: 10px; background: white; border: none;    
      font-size: 16px; text-align: left; cursor: pointer;    
    }    
    .dropdown-menu button:hover { background: #f0f0f0; }    
    
    .user {    
      background: white; padding: 10px; margin: 8px 10px;    
      border-radius: 8px; display: flex; align-items: center;    
      justify-content: space-between; gap: 12px;    
    }    
    
    .left { display: flex; align-items: center; gap: 12px; flex: 1; }    
    
    .dp {    
      width: 60px; height: 60px; border-radius: 50%;    
      background: blueviolet;    
      color: white; font-size: 20px;    
      display: flex; align-items: center; justify-content: center;    
      overflow: hidden; flex-shrink: 0; cursor: pointer;    
      position: relative;    
    }    
    .dp img { width: 100%; height: 100%; object-fit: cover; }    
    
    /* Online red border */    
    .dp.online {    
      border: 3px solid black;    
    }    
    
    .bottom-nav {    
      position: fixed; bottom: 0; left: 0; width: 100%;    
      background: white; display: flex; justify-content: space-around;    
      padding: 10px 0; box-shadow: 0 -2px 5px rgba(0,0,0,0.1);    
    }    
    .bottom-nav i { font-size: 22px; color: red; }    
    .bottom-nav .active { color: blueviolet; }    
    
    .badge {    
      position: absolute; top: -5px; right: -5px;    
      background: red; color: white;    
      font-size: 12px; padding: 2px 6px;    
      border-radius: 12px; min-width: 20px;    
      text-align: center;    
    }    
    
    .verified {    
      color: #1DA1F2;    
      font-size: 16px;    
      margin-left: 5px;    
    }    
    .wida {    
      font-size: 12px;    
      color: #555;    
      font-style: italic;    
    }    

    /* ðŸ”” Notification Popup Style */
   #notificationPopup {
  position: fixed;
  top: 15px;
  right: 50px;
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.25);
  display: none;
  z-index: 2000;
  animation: slideIn 0.3s ease;
  overflow: hidden;
  max-width: 320px;
  cursor: pointer;
}
#notificationPopup .notifContent {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
}
#notificationPopup .notifDp {
  width: 48px; height: 48px;
  border-radius: 50%;
  background: blueviolet;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  flex-shrink: 0;
  overflow: hidden;
}
#notificationPopup .notifDp img {
  width: 100%; height: 100%;
  object-fit: cover;
}
#notificationPopup .notifText {
  flex: 1;
}
#notificationPopup .notifUser {
  font-weight: bold;
  margin-bottom: 2px;
}
#notificationPopup .notifMsg {
  font-size: 14px;
  color: #333;
  margin-bottom: 2px;
}
#notificationPopup .notifTime {
  font-size: 11px;
  color: #666;
}
@keyframes slideIn {
  from { transform: translateX(120%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOut {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(120%); opacity: 0; }
}


input{
      flex: ;
      padding: 15px 60px;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      outline: none;
      color: black;
      background: #f1f1f1;
      display: flex;
    }
    

  </style>    
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">    
</head>    
<body> 

    
  <!-- Top Bar -->    
  <div class="topbar">    
    <span>Chatgram</span>    
    <div class="icons">    
      <i class="fas fa-search" onclick="goTo('search.html')"></i>    
      <i class="fas fa-heart" onclick="goTo('notification.html')"></i>    
      <div class="dropdown">    
        <i class="fas fa-cog" onclick="toggleMenu(event)"></i>    
        <div class="dropdown-menu" id="menu">    
          <button onclick="goTo('edit.html')">Profile Settings</button>    
          <button onclick="goTo('account.html')">Profile</button>    
          <button onclick="goTo('settings.html')">Settings</button>    
          <button onclick="goTo('info.html')">App Info</button>    
          <button onclick="goTo('group.html')">Join World Group</button>    
        </div>    
      </div>    
    </div>    
  </div>    
  
  <div>
  <input type="text" id="searchInput" placeholder="Search name or username..." oninput="searchUsers()" />
</div>
    
  <!-- Contact List -->    
  <div id="userList"><h3 style="padding:10px;">World Members:</h3></div>    
    
  <!-- Bottom Navigation -->    
  <div class="bottom-nav">    
    <i class="fas fa-home active" onclick="goTo('contacts.html')"></i>    
    <i class="fas fa-phone" onclick="goTo('call.html')"></i>    
    <i class="fas fa-user" onclick="goTo('account.html')"></i>    
  </div>    

  <!-- ðŸ”” Notification Popup -->
  <div id="notificationPopup">
  <div class="notifContent">
    <div class="notifDp" id="notifDp"></div>
    <div class="notifText">
      <div class="notifUser" id="notifUser"></div>
      <div class="notifMsg" id="notifMsg"></div>
      <div class="notifTime" id="notifTime"></div>
    </div>
  </div>
</div>
    
  <!-- Firebase -->    
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>    
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>    
    
  <script>    
    const firebaseConfig = {    
      apiKey: "AIzaSyB6oF-osZPetNgNOv9p-QA6gMVn7gCJtRg",    
      authDomain: "chatgram-app-a.firebaseapp.com",    
      databaseURL: "https://chatgram-app-a-default-rtdb.firebaseio.com",    
      projectId: "chatgram-app-a",    
      storageBucket: "chatgram-app-a.appspot.com",    
      messagingSenderId: "1067753841739",    
      appId: "1:1067753841739:web:6f14d525d89737172799ce"    
    };    
    firebase.initializeApp(firebaseConfig);    
    const db = firebase.database();    
    
    const username = localStorage.getItem("chat_username");    
    const userList = document.getElementById("userList");    
    if (!username) location.href = "login.html";    
    
    db.ref("status/" + username).set({ typing: false });    
    window.addEventListener("beforeunload", () => {    
      db.ref("status/" + username).remove();    
    });    
    
    async function loadUsers() {    
      const usersSnap = await db.ref("users").once("value");    
      const chatSnap = await db.ref("chats/" + username).once("value");    
    
      const chatUsers = new Set();    
      const messageCount = {};    
      if (chatSnap.exists()) {    
        Object.entries(chatSnap.val()).forEach(([uid, messages]) => {    
          chatUsers.add(uid);    
          messageCount[uid] = Object.keys(messages).length;    
        });    
      }    
    
      const followed = await db.ref("followers/" + username).once("value");    
      const followedUsers = followed.exists() ? Object.keys(followed.val()) : [];    
    
      const sortedUsers = [];    
      usersSnap.forEach(user => {    
        const uname = user.key;    
        const data = user.val();    
        if (uname === username) return;    
    
        const hasChat = chatUsers.has(uname);    
        const count = messageCount[uname] || 0;    
        sortedUsers.push({ uname, data, hasChat, count });    
      });    
    
      sortedUsers.sort((a, b) => b.count - a.count || b.hasChat - a.hasChat);    
    
      userList.innerHTML = "<h3 style='padding:10px;'>Chat Contacts:</h3>";    
    
      sortedUsers.forEach(({ uname, data, hasChat, count }) => {    
        const div = document.createElement("div");    
        div.className = "user";    
    
        const left = document.createElement("div");    
        left.className = "left";    
    
        const dp = document.createElement("div");    
        dp.className = "dp";    
        dp.onclick = (e) => {    
          e.stopPropagation();    
          localStorage.setItem("profile_user", uname);    
          location.href = "users-profile.html";    
        };    
    
        if (data.dp) {    
          const img = document.createElement("img");    
          img.src = data.dp;    
          dp.appendChild(img);    
        } else {    
          dp.innerText = data.name ? data.name.charAt(0).toUpperCase() : uname.charAt(0).toUpperCase();    
        }    
    
        if (count > 0) {    
          const badge = document.createElement("div");    
          badge.className = "badge";    
          badge.innerText = count;    
          dp.appendChild(badge);    
        }    
    
        const info = document.createElement("div");    
        let verifiedHtml = "";    
        let widaText = "";    
        if (uname === "chatgram" || uname === "ads") {    
          verifiedHtml = `<i class="fas fa-check-circle verified"></i>`;    
          widaText = `<div class="wida">Wida Account</div>`;    
        }    
    
        info.innerHTML = `    
          <b>${data.name} ${verifiedHtml}</b><br>    
          <small>@${uname}</small><br>    
          <span id="status-${uname}" style="font-size:12px; color:gray;">Loading...</span><br>    
          <span id="followers-${uname}" style="font-size:12px; color:#444;">Followers: ...</span>    
          ${widaText}    
        `;    
    
        left.appendChild(dp);    
        left.appendChild(info);    
        div.appendChild(left);    
    
        const right = document.createElement("div");    
        right.style.display = "flex";    
        right.style.flexDirection = "column";    
        right.style.alignItems = "flex-end";    
        right.style.gap = "5px";    
    
        if (followedUsers.includes(uname)) {    
          const msgBtn = document.createElement("button");    
          msgBtn.innerText = "Message";    
          msgBtn.style.padding = "5px 10px";    
          msgBtn.style.background = "blueviolet";    
          msgBtn.style.color = "white";    
          msgBtn.style.border = "none";    
          msgBtn.style.borderRadius = "6px";    
          msgBtn.style.cursor = "pointer";    
          msgBtn.onclick = (e) => {    
            e.stopPropagation();    
            localStorage.setItem("chat_with", uname);    
            localStorage.setItem("chat_with_name", data.name);    
            location.href = "chat.html";    
          };    
          right.appendChild(msgBtn);    
        } else {    
          const followBtn = document.createElement("button");    
          followBtn.innerText = "Follow";    
          followBtn.style.padding = "5px 10px";    
          followBtn.style.background = "green";    
          followBtn.style.color = "white";    
          followBtn.style.border = "none";    
          followBtn.style.borderRadius = "6px";    
          followBtn.style.cursor = "pointer";    
          followBtn.onclick = async (e) => {    
            e.stopPropagation();    
            await db.ref("followers/" + username + "/" + uname).set(true);    
            loadUsers();    
          };    
          right.appendChild(followBtn);    
        }    
    
        div.appendChild(right);    
        userList.appendChild(div);    
    
        // Followers count realtime    
        db.ref("followers/" + uname).on("value", snap => {    
          const el = document.getElementById("followers-" + uname);    
          if (el) {    
            el.innerText = "Followers: " + (snap.exists() ? Object.keys(snap.val()).length : 0);    
          }    
        });    
    
        // Status + DP border    
        db.ref("status/" + uname).on("value", statusSnap => {    
          const status = statusSnap.val();    
          const statusEl = document.getElementById("status-" + uname);    
          if (statusEl) {    
            if (status?.typing) {    
              statusEl.innerText = "Typing...";    
              statusEl.style.color = "blue";    
              dp.classList.add("online");    
            } else if (status) {    
              statusEl.innerText = "Online";    
              statusEl.style.color = "green";    
              dp.classList.add("online");    
            } else {    
              statusEl.innerText = "Offline";    
              statusEl.style.color = "gray";    
              dp.classList.remove("online");    
            }    
          }    
        });    
      });    
    }    
    
    loadUsers();    
    
    function goTo(page) { location.href = page; }    
    function toggleMenu(e) {    
      e.stopPropagation();    
      document.getElementById("menu").classList.toggle("show");    
    }    
    window.addEventListener("click", () => {    
      const menu = document.getElementById("menu");    
      if (menu) menu.classList.remove("show");    
    });    

    /* ðŸ”” Notification Logic */
    function showNotification(uname, name, dp, message, timestamp) {
  const popup = document.getElementById("notificationPopup");
  const notifUser = document.getElementById("notifUser");
  const notifMsg = document.getElementById("notifMsg");
  const notifTime = document.getElementById("notifTime");
  const notifDp = document.getElementById("notifDp");

  notifUser.innerText = name;
  notifMsg.innerText = message.length > 40 ? message.substring(0,40)+"..." : message;

  const time = new Date(timestamp);
  notifTime.innerText = `${time.getHours().toString().padStart(2,"0")}:${time.getMinutes().toString().padStart(2,"0")}`;

  notifDp.innerHTML = "";
  if (dp) {
    const img = document.createElement("img");
    img.src = dp;
    notifDp.appendChild(img);
  } else {
    notifDp.innerText = name ? name.charAt(0).toUpperCase() : uname.charAt(0).toUpperCase();
  }

  popup.style.display = "block";
  popup.style.animation = "slideIn 0.3s ease";

  // Click -> open chat
  popup.onclick = () => {
    localStorage.setItem("chat_with", uname);
    localStorage.setItem("chat_with_name", name);
    location.href = "chat.html";
  };

  // Auto hide after 4 sec
  setTimeout(() => { hideNotification(); }, 4000);
}

// ðŸ‘‰ Hide with animation
function hideNotification() {
  const popup = document.getElementById("notificationPopup");
  popup.style.animation = "slideOut 0.3s ease";
  setTimeout(()=>{ popup.style.display="none"; }, 300);
}

// ðŸ‘‰ Swipe gesture support
(function() {
  const popup = document.getElementById("notificationPopup");
  let startX = 0;
  popup.addEventListener("touchstart", e => {
    startX = e.touches[0].clientX;
  });
  popup.addEventListener("touchend", e => {
    let endX = e.changedTouches[0].clientX;
    if (Math.abs(endX - startX) > 50) {
      hideNotification();
    }
  });
})();

// ðŸ‘‰ Listen Firebase new messages
function listenForMessages(username) {
  const dbRef = firebase.database().ref("chats");
  dbRef.on("child_added", (snap) => {
    const chatId = snap.key;
    firebase.database().ref("chats/" + chatId).limitToLast(1).on("child_added", async (msgSnap) => {
      const data = msgSnap.val();
      if (data.sender !== username) {
        const chatWith = chatId.replace(username + "_", "").replace("_" + username, "");
        const userSnap = await firebase.database().ref("users/" + chatWith).once("value");
        const userData = userSnap.val() || {};
        showNotification(chatWith, userData.name || chatWith, userData.dp, data.message || (data.caption ?? "Media"), data.timestamp);
      }
    });
  });
}

// ðŸ‘‰ Start after login
if (username) listenForMessages(username);



//ðŸ”ðŸ”ðŸ”ðŸ”ðŸ”

  let allUsers = []; // ðŸ”¹ sabhi users ko store karne ke liye

  async function loadUsers() {
    const usersSnap = await db.ref("users").once("value");
    const chatSnap = await db.ref("chats/" + username).once("value");

    const chatUsers = new Set();
    const messageCount = {};
    if (chatSnap.exists()) {
      Object.entries(chatSnap.val()).forEach(([uid, messages]) => {
        chatUsers.add(uid);
        messageCount[uid] = Object.keys(messages).length;
      });
    }

    const followed = await db.ref("followers/" + username).once("value");
    const followedUsers = followed.exists() ? Object.keys(followed.val()) : [];

    const sortedUsers = [];
    usersSnap.forEach(user => {
      const uname = user.key;
      const data = user.val();
      if (uname === username) return;

      const hasChat = chatUsers.has(uname);
      const count = messageCount[uname] || 0;
      sortedUsers.push({ uname, data, hasChat, count });
    });

    sortedUsers.sort((a, b) => b.count - a.count || b.hasChat - a.hasChat);

    // ðŸ”¹ Global array me save karte hain search ke liye
    allUsers = sortedUsers;

    renderUsers(sortedUsers, followedUsers);
  }

  // ðŸ”¹ Users ko render karne ka alag function
  function renderUsers(users, followedUsers) {
    userList.innerHTML = "<h3 style='padding:10px;'>Chat Contacts:</h3>";

    users.forEach(({ uname, data, hasChat, count }) => {
      const div = document.createElement("div");
      div.className = "user";

      const left = document.createElement("div");
      left.className = "left";

      const dp = document.createElement("div");
      dp.className = "dp";
      dp.onclick = (e) => {
        e.stopPropagation();
        localStorage.setItem("profile_user", uname);
        location.href = "users-profile.html";
      };

      if (data.dp) {
        const img = document.createElement("img");
        img.src = data.dp;
        dp.appendChild(img);
      } else {
        dp.innerText = data.name ? data.name.charAt(0).toUpperCase() : uname.charAt(0).toUpperCase();
      }

      if (count > 0) {
        const badge = document.createElement("div");
        badge.className = "badge";
        badge.innerText = count;
        dp.appendChild(badge);
      }

      const info = document.createElement("div");
      let verifiedHtml = "";
      let widaText = "";
      if (uname === "chatgram" || uname === "ads") {
        verifiedHtml = `<i class="fas fa-check-circle verified"></i>`;
        widaText = `<div class="wida">Wida Account</div>`;
      }

      info.innerHTML = `
        <b>${data.name} ${verifiedHtml}</b><br>
        <small>@${uname}</small><br>
        <span id="status-${uname}" style="font-size:12px; color:gray;">Loading...</span><br>
        <span id="followers-${uname}" style="font-size:12px; color:#444;">Followers: ...</span>
        ${widaText}
      `;

      left.appendChild(dp);
      left.appendChild(info);
      div.appendChild(left);

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.flexDirection = "column";
      right.style.alignItems = "flex-end";
      right.style.gap = "5px";

      if (followedUsers.includes(uname)) {
        const msgBtn = document.createElement("button");
        msgBtn.innerText = "Message";
        msgBtn.style.padding = "5px 10px";
        msgBtn.style.background = "blueviolet";
        msgBtn.style.color = "white";
        msgBtn.style.border = "none";
        msgBtn.style.borderRadius = "6px";
        msgBtn.style.cursor = "pointer";
        msgBtn.onclick = (e) => {
          e.stopPropagation();
          localStorage.setItem("chat_with", uname);
          localStorage.setItem("chat_with_name", data.name);
          location.href = "chat.html";
        };
        right.appendChild(msgBtn);
      } else {
        const followBtn = document.createElement("button");
        followBtn.innerText = "Follow";
        followBtn.style.padding = "5px 10px";
        followBtn.style.background = "green";
        followBtn.style.color = "white";
        followBtn.style.border = "none";
        followBtn.style.borderRadius = "6px";
        followBtn.style.cursor = "pointer";
        followBtn.onclick = async (e) => {
          e.stopPropagation();
          await db.ref("followers/" + username + "/" + uname).set(true);
          loadUsers();
        };
        right.appendChild(followBtn);
      }

      div.appendChild(right);
      userList.appendChild(div);

      // Followers count realtime
      db.ref("followers/" + uname).on("value", snap => {
        const el = document.getElementById("followers-" + uname);
        if (el) {
          el.innerText = "Followers: " + (snap.exists() ? Object.keys(snap.val()).length : 0);
        }
      });

      // Status update
      db.ref("status/" + uname).on("value", statusSnap => {
        const status = statusSnap.val();
        const statusEl = document.getElementById("status-" + uname);
        if (statusEl) {
          if (status?.typing) {
            statusEl.innerText = "Typing...";
            statusEl.style.color = "blue";
            dp.classList.add("online");
          } else if (status) {
            statusEl.innerText = "Online";
            statusEl.style.color = "green";
            dp.classList.add("online");
          } else {
            statusEl.innerText = "Offline";
            statusEl.style.color = "gray";
            dp.classList.remove("online");
          }
        }
      });
    });
  }

  // ðŸ”Ž Search Function
  function searchUsers() {
    const query = document.getElementById("searchInput").value.toLowerCase().trim();
    const followed = []; // ðŸ”¹ optionally, aap DB se le sakte ho agar zaroori ho
    if (query === "") {
      renderUsers(allUsers, followed);
    } else {
      const filtered = allUsers.filter(u =>
        (u.data.name && u.data.name.toLowerCase().includes(query)) ||
        u.uname.toLowerCase().includes(query)
      );
      renderUsers(filtered, followed);
    }
  }

  </script>    
</body>    
</html>
