<!DOCTYPE html>  
<html>  
<head>  
  <title>Chatgram - Voice Call</title>  
  <meta name="viewport" content="width=device-width, initial-scale=1">  
  <style>  
    body { margin:0; background:#fff; color:#777fff; display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; font-family:sans-serif; }  
    .info { text-align:center; margin-bottom:20px; }  
    audio, video { display:none; }  
    .controls { display:flex; gap:20px; justify-content:center; margin-top:20px; }  
    button { width:60px; height:60px; border:none; border-radius:50%; font-size:22px; cursor:pointer; display:flex; justify-content:center; align-items:center; }  
    .end { background:red; color:white; }  
    .mute, .speaker, .video { background:#999; color:white; }  
    #timer { margin-top:10px; font-size:16px; color:#bbb; }  
  
    .dp {  
      width:120px; height:120px;  
      border-radius:50%; background:#677fff;  
      display:flex; justify-content:center; align-items:center;  
      font-size:50px; font-weight:bold; color:white;  
      overflow:hidden; margin:0 auto 15px;  
    }  
    .dp img {  
      width:100%; height:100%;  
      object-fit:cover;  
    }  
    
    button svg {
  pointer-events: none;
}

button.end {
  background: red;
  display: flex;
  justify-content: center;
  align-items: center;
}
button.active {
  background: #555fff;  /* highlight background */
  box-shadow: ;
}

  </style>  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">  
</head>  
<body>  
  <div class="info">  
    <div class="dp" id="dpBox"></div>  
    <h2 id="callWith">Calling</h2>  
    <p id="status">Connecting...</p>  
    <div id="timer">00:00</div>  
  </div>  
  
  <div class="controls">    
  <button class="mute" onclick="toggleActive(this); toggleMute()">
    <i class="fas fa-microphone"></i>
  </button>    

  <button class="speaker" onclick="toggleActive(this); toggleSpeaker()">
    <i class="fas fa-volume-up"></i>
  </button>    

  <button class="video" onclick="toggleActive(this); switchToVideo()">
    <i class="fas fa-video"></i>
  </button>    

  <!-- End Call (No active highlight) -->
  <button class="end" onclick="endCall()">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 122.88 122.88" width="28" height="28">
      <path fill="white" d="M74.59,55.72a49.79,49.79,0,0,0-12.38-2.07A41.52,41.52,0,0,0,48,55.8a1.16,1.16,0,0,0-.74.67,4.53,4.53,0,0,0-.27,1.7,16.14,16.14,0,0,0,.2,2c.42,3,.93,6.8-2.42,8l-.22.07-12,3.24-.12,0A4.85,4.85,0,0,1,28,70a11.44,11.44,0,0,1-2.68-4.92,11,11,0,0,1,.42-6.93A23.69,23.69,0,0,1,29,52.39,21.52,21.52,0,0,1,36.55,46a42.74,42.74,0,0,1,10.33-3.6l.29-.07C49,42,51,41.48,53.08,41.17a62.76,62.76,0,0,1,25.14,1.59c6.87,2,13,5.43,16.8,10.7a13.88,13.88,0,0,1,2.92,9.59,12.64,12.64,0,0,1-4.88,8.43,1.34,1.34,0,0,1-1.26.28L78.6,68.38A3.69,3.69,0,0,1,75.41,66a7.73,7.73,0,0,1-.22-4,15.21,15.21,0,0,1,.22-1.6c.3-1.89.63-4.06-.89-4.72Z"/>
    </svg>
  </button>    
</div>
  
  <audio id="remoteAudio" autoplay></audio>  
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>  
  <script>  
    const firebaseConfig = {   
      apiKey: "AIzaSyB6oF-osZPetNgNOv9p-QA6gMVn7gCJtRg",  
      authDomain: "chatgram-app-a.firebaseapp.com",  
      databaseURL: "https://chatgram-app-a-default-rtdb.firebaseio.com",  
      projectId: "chatgram-app-a",  
      storageBucket: "chatgram-app-a.appspot.com",  
      messagingSenderId: "1067753841739",  
      appId: "1:1067753841739:web:6f14d525d89737172799ce"  
    };  
    firebase.initializeApp(firebaseConfig);  
    const db = firebase.database();  
  
    const username = localStorage.getItem("chat_username");  
    const callWith = localStorage.getItem("call_with");  
    const callWithDp = localStorage.getItem("call_with_dp"); // dp image url (if available)  
    document.getElementById("callWith").innerText = "Voice Call with " + callWith;  
  
    // Show DP or first letter  
    const dpBox = document.getElementById("dpBox");  
    if(callWithDp && callWithDp !== "null"){  
      dpBox.innerHTML = `<img src="${callWithDp}" alt="DP">`;  
    } else {  
      dpBox.textContent = callWith.charAt(0).toUpperCase();  
    }  
  
    const peer = new RTCPeerConnection();  
    const remoteAudio = document.getElementById("remoteAudio");  
    let localStream;  
  
    navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{  
      localStream = stream;  
      stream.getTracks().forEach(track=>peer.addTrack(track, stream));  
      document.getElementById("status").innerText = "On Call...";  
      startTimer();  
    });  
  
    peer.ontrack = (e)=>{ remoteAudio.srcObject = e.streams[0]; };  
  
    const callId = username < callWith ? username+"_"+callWith : callWith+"_"+username;  
    const callRef = db.ref("webrtc_voice/" + callId);  
  
    peer.onicecandidate = (event)=>{  
      if(event.candidate){  
        callRef.child("candidates/" + username).push(JSON.stringify(event.candidate));  
      }  
    };  
  
    async function initCall(){  
      const offer = await peer.createOffer();  
      await peer.setLocalDescription(offer);  
      await callRef.child("offer").set(JSON.stringify(offer));  
      callRef.child("answer").on("value", async snap=>{  
        if(snap.exists()){  
          const answer = JSON.parse(snap.val());  
          await peer.setRemoteDescription(answer);  
        }  
      });  
      callRef.child("candidates/" + callWith).on("child_added", async s=>{  
        await peer.addIceCandidate(new RTCIceCandidate(JSON.parse(s.val())));  
      });  
    }  
  
    async function joinCall(){  
      callRef.child("offer").on("value", async snap=>{  
        if(snap.exists()){  
          const offer = JSON.parse(snap.val());  
          await peer.setRemoteDescription(offer);  
          const answer = await peer.createAnswer();  
          await peer.setLocalDescription(answer);  
          await callRef.child("answer").set(JSON.stringify(answer));  
        }  
      });  
      callRef.child("candidates/" + callWith).on("child_added", async s=>{  
        await peer.addIceCandidate(new RTCIceCandidate(JSON.parse(s.val())));  
      });  
    }  
  
    if(username < callWith){ initCall(); } else { joinCall(); }  
  
    // ---- Extra Features ----  
    function toggleMute(){  
      const track = localStream.getAudioTracks()[0];  
      track.enabled = !track.enabled;  
      document.querySelector(".mute i").className = track.enabled ? "fas fa-microphone" : "fas fa-microphone-slash";  
    }  
  
    function toggleSpeaker(){  
      alert("Speaker toggle किया गया (browser support पर depend करेगा)");  
    }  
  
    function switchToVideo(){  
      localStorage.setItem("call_mode", "video");  
      window.location.href = "videocall.html";  
    }  
  
    function endCall(){  
      callRef.remove();  // दोनों के लिए call खत्म  
      cleanupAndExit();  
    }  
  
    // ---- Listen if other user ended call ----  
    callRef.on("value", snap=>{  
      if(!snap.exists()){   
        cleanupAndExit();  
      }  
    });  
  
    function cleanupAndExit(){  
      if(localStream){  
        localStream.getTracks().forEach(track => track.stop());  
      }  
      clearInterval(timerInterval);  
      location.href = "call.html";  
    }  
  
    // ---- Call Timer ----  
    let seconds = 0, timerInterval;  
    function startTimer(){  
      timerInterval = setInterval(()=>{  
        seconds++;  
        const m = String(Math.floor(seconds/60)).padStart(2,"0");  
        const s = String(seconds%60).padStart(2,"0");  
        document.getElementById("timer").innerText = `${m}:${s}`;  
      },1000);  
    }  
    
    function toggleActive(btn){
  btn.classList.toggle("active");
}
  </script>  
</body>  
</html>